user owncloud www-data;
master_process off;
daemon off;

error_log /var/log/owncloud/error.log;

events {
}

http {
	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;
	keepalive_timeout 65;

	types_hash_max_size 2048;
	include /etc/nginx/mime.types;
	default_type application/octet-stream;

	access_log off;

	server {
		listen unix:/var/www/owncloud/backend.sock default_server;
		server_name _;
		root /opt/owncloud/public;
		client_max_body_size 129M;
		rewrite ^/caldav(.*)$ /remote.php/caldav$1 redirect;
		rewrite ^/carddav(.*)$ /remote.php/carddav$1 redirect;
		rewrite ^/webdav(.*)$ /remote.php/webdav$1 redirect;
		index index.php;
		error_page 403 /core/templates/403.php;
		error_page 404 /core/templates/404.php;
		location ~ ^/(?:\.htaccess|data|config|db_structure\.xml|README) {
			deny all;
		}
		location / {
			rewrite ^/.well-known/host-meta /public.php?service=host-meta last;
			rewrite ^/.well-known/host-meta.json /public.php?service=host-meta-json last;
			rewrite ^/.well-known/carddav /remote.php/carddav/ redirect;
			rewrite ^/.well-known/caldav /remote.php/caldav/ redirect;
			rewrite ^(/core/doc/[^\/]+/)$ $1/index.html;
			try_files $uri $uri/ index.php;
		}
		location ~ \.php(?:$|/) {
			fastcgi_split_path_info ^(.+\.php)(/.+)$;
			include /etc/nginx/fastcgi_params;
			fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
			fastcgi_param PATH_INFO $fastcgi_path_info;
			fastcgi_param HTTPS on;
			fastcgi_pass unix:/var/run/php5-fpm.sock;
		}
		location ~* \.(?:jpg|jpeg|gif|bmp|ico|png|css|js|swf)$ {
			expires 30d;
		}
	}
}
